@echo off
break off

set bin=\COBALT\BIN
set zip=\COBALT\ZIP
set ver=1.3

echo Loading setup...
echo.
cls

:setup
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Press ENTER to continue."
echo.
echo  Cobalt is a new operating system based on FreeDOS, designed to be easy
echo  to use. Unlike FreeDOS, Cobalt is designed for users with no previous
echo  DOS experience.
echo.
echo  Cobalt is still in development, so you might encounter bugs. Please report
echo  bugs to https://github.com/Atnode/Cobalt/issues.
echo.
echo  This setup will install Cobalt to your computer's internal drive. If you
echo  already have FreeDOS, MS-DOS, etc on your computer already, you will be
echo  able to upgrade to Cobalt.
echo.
pause >nul
%bin%\SUSCR.EXE /M "Setup is checking partitions on your hard drives..."
%bin%\GDISK.EXE 1|%bin%\FIND.EXE "No partitions defined" > nul
if not errorlevel 1 goto invdc
%bin%\GDISK.EXE 1|%bin%\FIND.EXE " PRI DOS"|%bin%\FIND.EXE "DOS"|%bin%\FIND.EXE "FAT" > nul
if errorlevel 1 goto nofatdc
%bin%\GDISK.EXE 1|%bin%\FIND.EXE " PRI DOS"|%bin%\FIND.EXE "C:"|%bin%\FIND.EXE "Unformatted"|%bin%\FIND.EXE "FAT" > nul
if not errorlevel 1 goto nofmtdc
goto chkact

:invdc
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Do you want format the hard drive?" /F "Y/N?"
echo.
echo  The main drive is not formatted. Do you wish to use it with Cobalt?
echo.
echo  WARNING: This will erase all data. Make sure to backup all
echo  important data before formatting.
echo.
%bin%\%bin%\CHOICE.EXE > nul
if errorlevel 2 goto cancel
if not errorlevel 2 %bin%\SUSCR.EXE /M "Formatting the hard drive..."|%bin%\GDISK.EXE 1 /cre /pri /for /q /v:COBALT > nul
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup "
echo.
echo  The format was successful.
echo.
echo  Please restart your computer for the changes to apply, then you start
echo  the installer again.
echo.
goto loop

:nofatdc
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup "
echo.
echo  There is no Primary FAT file system on your hard drive, or there
echo  are no detected hard drives at all.
echo.
echo  Installation cannot continue, please restart your computer.
echo.
goto loop

:nofmtdc
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Do you want to use the primary partition with Cobalt?" /F "Y/N?"
echo.
echo  The primary partition is not formatted. Do you wish to use it with Cobalt?
echo.
%bin%\CHOICE.EXE > nul
if errorlevel 2 goto cancel
if not errorlevel 2 %bin%\SUSCR.EXE /M "Formatting the hard drive..."|%bin%\FORMAT.EXE c: /z:seriously /v:COBALT /s /y|goto ready

:chkact
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup "
echo.
echo  Your hard drive was blank, so a new partition for Cobalt was created.
echo.
%bin%\GDISK.EXE 1|%bin%\FIND.EXE "      PRI DOS"|%bin%\FIND.EXE "C:"|%bin%\FIND.EXE "FAT" > nul
if not errorlevel 1 goto noactdc
goto mbr

:noactdc
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Making file system active..."
if errorlevel 1 if not errorlevel 2 %bin%\GDISK.EXE 1 /act /p:1
goto mbr

:mbr
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Do you want to overwrite the MBR?" /F "Y/N?"
echo.
echo  Rewriting the Master Boot Record (MBR) of your hard drive will ensure
echo  Cobalt will boot properly.
echo.
echo  If you use a custom boot manager (like GRUB) and want to keep it, DO
echo  NOT overwrite the MBR. If you have no idea what an MBR or GRUB is,
echo  just choose yes.
echo.
%bin%\CHOICE.EXE > nul
if errorlevel 2 goto mbrconfirm
if not errorlevel 2 goto oscheck

:mbrconfirm
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Rewriting the MBR..."
%bin%\GDISK.EXE 1 /mbr > nul
goto oscheck

:oscheck
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Checking for installed operating systems..."
if exist C:\SYSTEM\4DOS\4DOS.INI goto upgradecobalt
if exist C:\COMMAND.COM goto upgradedos
if exist C:\MSDOS.SYS goto upgradedos
if exist C:\KERNEL.SYS goto upgradedos
goto freshinstall

:upgradecobalt
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Install Cobalt to the C: drive?" /F "Y/N?"
echo.
echo  This installer has detected a previous installation of Cobalt
echo  on this drive. It will be upgraded to the current installation.
echo.
echo  The previous SYSTEM folder will be deleted and replaced with
echo  the Cobalt 1.3 system folder.
echo.
echo  Press Y to begin the install, or N to cancel.
echo.
%bin%\CHOICE.EXE > nul
if errorlevel 2 goto cancel
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Deleting previous Cobalt installation..."
%bin%\DELTREE.COM /Y /Z:SERIOUSLY C:\SYSTEM
%bin%\SUSCR.EXE /D " Cobalt OS Repair " /M "Removing hidden flags on system files (if applicable)..."
%bin%\ATTRIB.COM -H C:\AUTOEXEC.BAT
%bin%\ATTRIB.COM -H C:\CONFIG.SYS
%bin%\ATTRIB.COM -H C:\KERNEL.SYS
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Installing base DOS system..."
%bin%\SYS.COM A: C:
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Decompressing %zip%\BASE.ZIP..."
%bin%\UNZIP.exe -o -q %zip%\BASE.ZIP -d c:\
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Decompressing %zip%\EN.ZIP..."
%bin%\UNZIP.exe -o -q %zip%\EN.ZIP -d c:\
if not errorlevel 0 goto error
del c:\COMMAND.COM
goto askdesktop

:upgradedos
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Install Cobalt to the C: drive?" /F "Y/N?"
echo.
echo  This installer has detected a previous installation of a
echo  DOS-based operating system, such as FreeDOS or MS-DOS.
echo.
echo  Cobalt will move the current AUTOEXEC.BAT and CONFIG.SYS
echo  files to AUTOEXEC.OLD and CONFIG.OLD, respectively. No
echo  other files will be modified.
echo.
echo  Press Y to begin the install, or N to cancel.
echo.
%bin%\CHOICE.EXE > nul
if errorlevel 2 goto cancel
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Renaming existing DOS files..."
%bin%\ATTRIB.COM -H C:\AUTOEXEC.BAT
%bin%\ATTRIB.COM -H C:\CONFIG.SYS
COPY C:\CONFIG.SYS C:\CONFIG.OLD
COPY C:\AUTOEXEC.BAT C:\AUTOEXEC.OLD
DEL C:\CONFIG.SYS
DEL C:\AUTOEXEC.BAT
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Installing base DOS system..."
%bin%\SYS.COM A: C:
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Decompressing %zip%\BASE.ZIP..."
%bin%\UNZIP.exe -o -q %zip%\BASE.ZIP -d c:\
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Decompressing %zip%\EN.ZIP..."
%bin%\UNZIP.exe -o -q %zip%\EN.ZIP -d c:\
if not errorlevel 0 goto error
del c:\COMMAND.COM
goto askdesktop

:freshinstall
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Install Cobalt to the drive?" /F "Y/N?"
echo.
echo  Cobalt is now ready to install to the C: drive.
echo  THIS WILL DELETE ALL FILES ON THE C: DRIVE.
echo.
echo  Press Y to begin the install, or N to cancel.
echo.
%bin%\CHOICE.EXE > nul
if errorlevel 2 goto cancel
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Copying base system files..."
%bin%\FORMAT.EXE c: /z:seriously /v:COBALT /s /y
if not errorlevel 0 goto error
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Decompressing %zip%\BASE.ZIP..."
%bin%\UNZIP.exe -o -q %zip%\BASE.ZIP -d c:\
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Decompressing %zip%\EN.ZIP..."
%bin%\UNZIP.exe -o -q %zip%\EN.ZIP -d c:\
if not errorlevel 0 goto error
del c:\COMMAND.COM
goto askdesktop

:askdesktop
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Install desktop?" /F "Y/N?"
echo.
echo  You can optionally install a desktop environment, called
echo  OpenGEM, so you don't have to use the command line. After
echo  Cobalt boots up, you can just type "GEM" and press ENTER
echo  to start the desktop.
echo.
echo  Press Y to install the desktop, or N to skip this step.
echo.
%bin%\CHOICE.EXE > nul
if errorlevel 2 goto complete
if not errorlevel 2 goto installdesktop

:installdesktop
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Decompressing DESKTOP.ZIP..."
%bin%\UNZIP.exe -o -q DESKTOP.ZIP -d c:\
if not errorlevel 0 goto error
goto complete

:complete
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup " /M "Finished installation."
echo.
echo  Congratulations, Cobalt has been installed to your computer's hard
echo  drive! Please eject the install disc and press ENTER
echo  to restart your computer.
pause >nul
goto reboot

:error
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup "
echo.
echo  An error has occurred, please press ENTER
echo  to restart your computer.
echo.
pause >nul
goto reboot

:cancel
%bin%\SUSCR.EXE /D " Cobalt %ver% Setup "
echo.
echo  The Cobalt installation has been canceled. Please press ENTER
echo  to restart your computer
echo.
pause >nul
goto reboot

:reboot
cls
A:\DRIVERS\FDAPM WARMBOOT
cls
